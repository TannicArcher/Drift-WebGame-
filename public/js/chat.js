"undefined"==typeof public&&(public={}),public.chat={option:{data:{},audio:"#chat-box audio",message:{list:"#chat-box .message-block .chat-message-list",history:"#chat-box .message-block .chat-message-list .history",refreshTime:1,refreshCnt:1,stamp:null,deletedId:[],newId:void 0,successId:void 0,new:"#chat-box .message-block .new-message"},online:{list:"#chat-box .online-block .chat-online-list",count:"#chat-box .online-block .title .count",stamp:null,listId:void 0},form:{block:"#chat-box form",down:"#chat-box form .panel .down",smile:"#chat-box form .panel .smile",sound:"#chat-box form .panel .sound",smileBlock:"#chat-box form .smile-block",button:"#chat-box form button"}},init:function(){var t=public.chat.option;public.chat.list({action:"first",first:1}),public.chat.onlineList({first:1}),$("#chat-box .chat-message-list, #chat-box .chat-online-list").on("click",".item .login",function(){public.chat.loginInsert({el:$(this)})}),$(t.message.list).scroll(function(){0==$(t.message.list).scrollTop()&&$(t.message.history).length&&public.chat.list({action:"history",preloader:t.message.history})}),$(t.form.down+", "+t.message.new).on("click",function(){core.main.scrollInside(t.message.list,500),$(t.message.new).slideUp(500)}),$(t.message.list).scroll(function(){$(t.message.list).height()+$(t.message.list).scrollTop()+100>=$(t.message.list).prop("scrollHeight")&&$(t.message.new).slideUp(500)}),$(t.form.smile).on("click",function(){public.chat.smilePanel()}),$(document).click(function(e){var t=$.extend({},public.chat.option,e);$(t.target).closest(t.form.block).length||$(t.form.smileBlock).is(":visible")&&$(t.form.smileBlock).stop().slideUp(200)}),$(t.form.smileBlock+" img").on("click",function(){public.chat.smileInsert({el:$(this)})}),$(t.form.sound).on("click",function(){var e=$(this).hasClass("fa-volume-mute")?1:0;$(this).removeClass(e?"fa-volume-mute":"fa-volume-up").addClass(e?"fa-volume-up":"fa-volume-mute"),public.chat.sound({value:e})}),$(t.message.list).on("click",".item .panel [data-action]",function(){public.chat.panel($(this))}),$(t.form.block).on("submit",function(){public.chat.send()});var s=!1,i=!1;$(t.form.block+" textarea").keydown(function(e){switch(e.which){case 13:return!1;case 16:i=!0;break;case 17:s=!0}}),$(t.form.block+" textarea").keyup(function(e){switch(e.which){case 13:if(!s&&!i)return $(t.form.block).submit(),!1;$(t.form.block+" textarea").insertAtCaret("\r\n");break;case 16:i=!1;break;case 17:s=!1}}),$("#chat-box .online-block .title .hamburger").on("click",function(){$("#chat-box .online-block .list-wrap").stop().slideToggle(100)})},smilePanel:function(){var e=public.chat.option;$(e.form.smileBlock).is(":visible")?$(e.form.smileBlock).stop().slideUp(200):$(e.form.smileBlock).stop().slideDown(200)},smileInsert:function(e){var t=$.extend({},public.chat.option,e);$(t.form.block+" textarea[name=text]").insertAtCaret(" [smile:"+$(t.el).attr("alt")+"] "),public.chat.smilePanel()},list:function(e){var i=$.extend({},public.chat.option,e);switch(i.action){case"first":i.preloader=i.message.list;break;case"new":null!=public.chat.option.message.newId&&clearTimeout(public.chat.option.message.newId);var t=$(i.message.list+" .item:first").attr("data-id"),s=$(i.message.list+" .item:last").attr("data-id");break;case"history":t=$(i.message.list+" .item:first").attr("data-id")}core.ajax({url:"/chat/list/action/"+i.action+"/first-id/"+(t||0)+"/last-id/"+(s||0)+"/stamp/"+(i.message.stamp||0),ident:"list"+i.action,preloader:i.preloader,form:i.form.block,success:function(e){if(e)switch(e.stamp&&(public.chat.option.message.stamp=e.stamp),e.map&&$(i.form.block+" input[name=map]").val(e.map),i.action){case"first":e.list&&($(i.message.list).html(e.list),core.main.scrollInside(i.message.list,500)),public.chat.list({action:"new",volume:"off",preloader:!1});break;case"new":public.chat.option.message.refreshTime=1,public.chat.option.message.refreshCnt=0;var t=parseInt(e.access);if(t=t||1,e["delete-id"])for(value in e["delete-id"])e["delete-id"][value]in public.chat.option.message.deletedId||(public.chat.option.message.deletedId.push(e["delete-id"][value]),t<2?$(i.message.list+" .item[data-id="+e["delete-id"][value]+"]").slideUp(500):$(i.message.list+" .item[data-id="+e["delete-id"][value]+"]").addClass("deleted"));e.list&&(i.down||$(i.message.list).height()+$(i.message.list).scrollTop()+50>=$(i.message.list).prop("scrollHeight")?setTimeout(function(){core.main.scrollInside(i.message.list,500)},100):$(i.message.new).slideDown(500),$(i.message.list+" .item").length?$(i.message.list+" .item:last").after(e.list):($(i.message.list).append(e.list),$(i.message.list+" .no-data").remove()),"off"!=i.volume&&parseInt(e.sound)&&parseInt(e["sound-chat"])&&$(i.audio)[0].play());break;case"history":if(e.list){var s=$(i.message.list).prop("scrollHeight");$(i.message.history).remove(),$(i.message.list).prepend(e.list).scrollTop($(i.message.list).prop("scrollHeight")-s)}}else"new"==i.action&&(++public.chat.option.message.refreshCnt,20<=public.chat.option.message.refreshCnt?public.chat.option.message.refreshTime=5:10<=public.chat.option.message.refreshCnt?public.chat.option.message.refreshTime=4:5<=public.chat.option.message.refreshCnt?public.chat.option.message.refreshTime=3:3<=public.chat.option.message.refreshCnt&&(public.chat.option.message.refreshTime=2))},complete:function(){"new"==i.action&&(public.chat.option.message.newId=setTimeout(function(){public.chat.list({action:"new",preloader:!1})},1e3*i.message.refreshTime))},error:function(e){return console.log(e)}})},onlineList:function(e){var t=$.extend({},public.chat.option,e);null!=public.chat.option.online.listId&&clearTimeout(public.chat.option.online.listId),core.ajax({url:"/chat/online/stamp/"+t.online.stamp,ident:"online",preloader:!!t.first&&t.online.list,success:function(e){e&&(e.stamp&&(public.chat.option.online.stamp=e.stamp),e.list&&($(t.online.count).removeClass("js-load").html(core.main.num(e.count)),$(t.online.list).html(e.list)))},complete:function(){public.chat.option.online.listId=setTimeout(function(){public.chat.onlineList()},5e3)}})},loginInsert:function(e){var t=$.extend({},public.chat.option,e);t.el.hasClass("my")||$(t.form.block+" [name=text]").insertAtCaret(" ["+t.el.text()+"], ")},panel:function(e){var t=public.chat.option,s=e.closest(".item").attr("data-id"),i=e.data("action");if(s&&i){var o="ban"==i?e.attr("data-time"):0;core.ajax({url:"/chat/control/id/"+s+"/action/"+i+"/time/"+o,ident:"action"+s,preloader:t.message.list+" .item[data-id="+s+"] .panel",success:function(e){e.error&&(e.error["not-access"]&&$(t.message.list+" .item[data-id="+s+"] .panel .message").html(e.error["not-access"]),e.error["already-ban"]&&$(t.message.list+" .item[data-id="+s+"] .panel .message").html(e.error["already-ban"])),e.success&&(public.chat.list({action:"new",volume:"off"}),$(t.message.list+" .item[data-id="+s+"] .panel .message").html('<span class="success">'+e.success+"</span>"))}})}},send:function(){var t=public.chat.option;core.ajax({url:"/chat/send",ident:"send",preloader:t.form.button,form:t.form.block,success:function(e){if(e&&e.error){if(e.error.ban)return swal({type:"error",text:e.error.ban});if(e.error.text)return swal({type:"error",text:e.error.text});if(e.error["long-text"])return swal({type:"error",text:e.error["long-text"]});if(e.error["confirm-email"])return swal({type:"error",text:e.error["confirm-email"]});if(e.error["no-funds"])return swal({type:"error",text:e.error["no-funds"]});if(e.error["links-allowed"])return swal({type:"error",text:e.error["links-allowed"]});if(e.error.frequency)return swal({type:"error",text:e.error.frequency})}e.success&&($(t.form.block+" [name=text]").val(""),public.chat.list({action:"new",volume:"off",down:!0}))}})},sound:function(e){var t=$.extend({},public.chat.option,e);core.ajax({url:"/chat/sound/value/"+t.value,ident:"sound-chat"})}},$(document).ready(function(){public.chat.init()});